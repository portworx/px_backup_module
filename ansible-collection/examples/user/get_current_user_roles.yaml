---
- name: Get Current User's Roles
  hosts: localhost
  gather_facts: false

  vars_files:
    - "{{ inventory_dir }}/group_vars/common/all.yaml"

  pre_tasks:
    - name: Validate required variables
      assert:
        that:
          - px_backup_api_url is defined
          - org_id is defined
        fail_msg: "Required variables must be defined"

  tasks:
    - name: Login and fetch Px-Backup token
      include_tasks: "{{ playbook_dir | dirname }}/auth/auth.yaml"

    - name: Get current user's roles
      block:
        - name: Fetch current user roles
          role:
            operation: GET_CURRENT_USER_ROLES
            api_url: "{{ px_backup_api_url }}"
            token: "{{ px_backup_token }}"
            org_id: "{{ org_id }}"
            ssl_config: "{{ ssl_config.px_backup | default({}) }}"
          register: user_roles_result

        - name: Display current user information
          debug:
            msg:
              - "Current User ID: {{ user_roles_result.user_info.user_id }}"
              - "Current User Email: {{ user_roles_result.user_info.email }}"
              - "Total roles owned by user: {{ user_roles_result.total_user_roles }}"
              - "Total roles in system: {{ user_roles_result.total_all_roles }}"

        - name: Display user's role names
          debug:
            msg: "User's roles: {{ user_roles_result.roles | map(attribute='metadata.name') | list }}"
          when: user_roles_result.total_user_roles > 0

        - name: Display detailed role information
          debug:
            var: user_roles_result.roles
          when: user_roles_result.total_user_roles > 0

        - name: Display message if no roles found
          debug:
            msg: "Current user does not own any roles"
          when: user_roles_result.total_user_roles == 0

      rescue:
        - name: Display error details
          debug:
            msg: "Failed to get current user roles: {{ user_roles_result.msg if user_roles_result.msg is defined else 'Unknown error occurred' }}"

        - name: Fail with error message
          fail:
            msg: "Failed to get current user roles. See above for details."

    # Output configuration: Display the output or save to file
    - name: Handle output
      include_tasks: "{{ playbook_dir | dirname }}/output_handler/main.yaml"
      vars:
        output_data: "{{ user_roles_result }}"
        output_filename_prefix: "current_user_roles"
      when: output_config.enabled | default(false)
